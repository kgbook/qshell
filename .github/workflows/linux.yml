name: linux

on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'BUILD.md'
      - 'CHANGELOG.md'
    tags:
      - 'V**'

jobs:
  ubuntu-2204:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          modules: 'qtserialport'
          aqtversion: '==3.1.20'

      - name: Install prerequisites
        run: |
          sudo apt update
          sudo apt install -y cmake build-essential clang-tidy

      # 非 tag 推送：仅构建
      - name: Build Only
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: |
          ./scripts/linux-build.sh

      # tag 推送：构建 + 打包
      - name: Build and Package
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # 从 tag 名称提取版本号 (去掉 'V' 或 'v' 前缀)
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^[Vv]//')
          ./scripts/linux-build.sh "${VERSION}"

      # 查找生成的 deb 文件并设置环境变量
      - name: Find DEB Package
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          DEB_FILE=$(ls build/*.deb 2>/dev/null | head -n 1)
          if [ -n "$DEB_FILE" ]; then
            echo "DEB_FILE=${DEB_FILE}" >> $GITHUB_ENV
            echo "Found DEB package: ${DEB_FILE}"
          else
            echo "No DEB file found!"
            exit 1
          fi

      # 上传 Release
      - name: Create Release and Upload
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.DEB_FILE }}
          draft: false
          prerelease: false
          generate_release_notes: true
